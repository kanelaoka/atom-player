app.controller("BrowseCtrl",function($rootScope,$location,$scope,$http,userService){$rootScope.activetab=$location.path(),userService.refreshRootScope(),$scope.search=function(q){void 0!==q.query?$http.post("/api/search",{query:q.query}).then(function(response){$scope.search.results=response.data,$scope.search_show=!0}):$scope.search_show=!1},$scope.searchClear=function(){$scope.search_show=!1,$scope.query=""}}),app.controller("LogoutCtrl",function($cookies,$location,userService){$cookies.remove("logged"),$cookies.remove("user_infos"),$cookies.remove("user_token"),$cookies.remove("user_type"),mixpanel.track("logout"),setTimeout(function(){$location.path("browse")},1e3)}),app.controller("LogSigCtrl",function($rootScope,$location,$scope,$http,$cookies,$routeParams,facebookService,userService){userService.isLogged()&&$location.path("/"),$scope.signIn=function(){if($scope.signinForm.$valid&&!$scope.signinForm.$pristine){$scope.cad_success=void 0,$scope.cad_error=void 0;var cad=$scope.cad;$http.post("/api/user",{first_name:cad.first_name,last_name:cad.last_name,email:cad.email,pass:cad.pass}).then(function(response){response.data.success?$scope.logInExec(cad.email,cad.pass):$scope.cad_error=response.data.response},function(err){$scope.cad_error="Erro inesperado ocorreu"})}else $scope.cad_error="O formulÃ¡rio possui erros!"},$scope.logInExec=function(email,pass){$http.post("/api/user/auth",{email:email,pass:pass}).then(function(res){res.data.success?($cookies.put("user_token",res.data.response),$cookies.put("user_type","atom"),$cookies.put("logged","true"),userService.loadInfos(),userService.refreshRootScope(),mixpanel.track("atom login"),setTimeout(function(){$location.path("/")},1e3)):$scope.log_error=res.data.response})},$scope.logIn=function(){if($scope.loginForm.$valid&&!$scope.loginForm.$pristine){$scope.log_error=void 0;var log=$scope.log;$scope.logInExec(log.email,log.pass)}},$scope.logInFb=function(){facebookService.login().then(function(res){"connected"==res.status&&$http.post("/api/userfb/auth",{fb_id:res.authResponse.userID}).then(function(api_res){api_res.data.success?($cookies.put("user_token",api_res.data.response),$cookies.put("user_type","facebook"),$cookies.put("logged","true"),userService.loadInfos(),userService.refreshRootScope(),mixpanel.track("facebook login"),setTimeout(function(){$location.path("/")},1e3)):$scope.log_error=api_res.data.response})})}}),app.controller("MenuCtrl",function($scope,$rootScope,$cookies,userService){}),app.controller("NotificationCtrl",function($rootScope,$location,$scope,$http,$routeParams){$rootScope.$on("notification.playing",function(e,data){var options={body:data.episode,icon:data.image};new Notification(data.podcast,options)})}),app.controller("PlayerCtrl",function($rootScope,$scope,$interval,$document){$rootScope.$on("control.init",function(e){$scope.podcast={title:"Atom Player",image:"/assets/img/play_image.png"},$scope.episode={title:"Atom Player"},$scope.button="fa-pause",$("#audio-src").attr("src",""),audio.load()}),$scope.$emit("control.init"),$rootScope.playlist=[],$rootScope.playing,$scope.muted=!1,$scope.lastVolume=0,audio.paused?$scope.button="fa-play":$scope.button="fa-pause",$interval(function(){progress.value=Math.round(audio.currentTime/audio.duration*100);var duration=audio.duration,min_dur=""+Math.floor(duration/60);min_dur=("00"+min_dur).substring(min_dur.length);var sec_dur=""+Math.floor(duration-60*min_dur);sec_dur=("00"+sec_dur).substring(sec_dur.length);var current=audio.currentTime,min_curr=""+Math.floor(current/60);min_curr=("00"+min_curr).substring(min_curr.length);var sec_curr=""+Math.floor(current-60*min_curr);sec_curr=("00"+sec_curr).substring(sec_curr.length),$scope.diff=min_curr+":"+sec_curr+" / "+min_dur+":"+sec_dur},5),$document.bind("keypress",function(e){if(e.target==document.body)switch(e.which){case 32:return $scope.playPause(),!1;case 109:$scope.muted?($scope.muted=!1,audio.volume=$scope.lastVolume):($scope.muted=!0,$scope.lastVolume=audio.volume,audio.volume=0)}}),$scope.changeTime=function(){var newTime=Math.round(progress.value/100*audio.duration);audio.currentTime=newTime},$scope.changeVolume=function(){audio.volume=volume.value/100},$scope.playPause=function(){audio.paused?(audio.play(),$scope.button="fa-pause"):(audio.pause(),$scope.button="fa-play")},$scope.previous=function(){$scope.$emit("control.prev")},$rootScope.$on("control.prev",function(e){$rootScope.playing>0&&($rootScope.playing-=1,$scope.$emit("episode.play",$rootScope.playlist[$rootScope.playing]))}),$scope.next=function(){$scope.$emit("control.next")},$rootScope.$on("control.next",function(e){$rootScope.playlist.length-1>$rootScope.playing&&($rootScope.playing+=1,$scope.$emit("episode.play",$rootScope.playlist[$rootScope.playing]))}),$rootScope.$on("episode.execute",function(e,data){audio.ended&&$scope.playlist.length-1==$rootScope.playing||void 0==$rootScope.playing?$rootScope.playlist.push(data):($rootScope.playing+=1,$rootScope.playlist.splice($rootScope.playing,0,data),$scope.$emit("episode.play",data))}),$rootScope.$on("episode.play",function(e,data){$scope.podcast=data.podcast,$scope.episode=data.episode,audio.pause(),$scope.button="fa-pause",$("#audio-src").attr("src",data.episode.enclosure.url),audio.load(),audio.play(),mixpanel.track("episode playing",{"podcast title":data.podcast.title,"episode title":data.episode.title}),$rootScope.$emit("notification.playing",{podcast:data.podcast.title,image:data.podcast.image,episode:data.episode.title})}),$rootScope.$on("episode.add",function(e,data){$rootScope.playlist.push(data)}),$scope.$watch(function(scope){return $rootScope.playlist.length},function(now,old){now>0&&(1==now&&0==old?($rootScope.playing=0,$scope.$emit("episode.play",$rootScope.playlist[0])):$rootScope.playing==now-2&&audio.ended&&($rootScope.playing=now-1,$scope.$emit("episode.play",$rootScope.playlist[$rootScope.playing])))}),$scope.$watch(function(scope){return audio.ended},function(stoped,old){stoped&&$rootScope.playlist.length-1>$rootScope.playing&&($rootScope.playing+=1,$scope.$emit("episode.play",$rootScope.playlist[$rootScope.playing]))})}),app.controller("PodcastCtrl",function($rootScope,$location,$scope,$http,$cookies,$routeParams,userService){$rootScope.activetab=$location.path(),userService.refreshRootScope(),$scope.loaded=!1;var id=$routeParams.id;id||$location.path("/");var podcast,url="/api/podcast/?id="+id;$http.get(url).then(function(res){console.log(res),podcast=res.data,podcast.srcId=id;var eps_num=podcast.episodes.length;if(eps_num>0)for(var i=0;i<eps_num;i++){var tmp_duration=podcast.episodes[i].duration;podcast.episodes[i].duration=Math.round(tmp_duration/60);var dt=new Date(podcast.episodes[i].published),srtDt=dt.toLocaleString().split(" ");podcast.episodes[i].srtDate=srtDt[0]}$scope.podcast=podcast,$scope.loaded=!0,mixpanel.track("podcast view",{"podcast id":id,"podcast title":podcast.title})}),userService.isLogged()&&userService.getPodcasts().then(function(res){if(res.data.success)for(var i=0;i<res.data.response.podcasts.length;i++)res.data.response.podcasts[i].srcId==id&&($scope.signed=!0)}),$scope.exec=function(tag,type){for(var i=0;i<podcast.episodes.length;i++)podcast.episodes[i].guid==tag&&$rootScope.$emit("episode."+type,{podcast:{id:podcast.srcId,title:podcast.title,image:podcast.image},episode:podcast.episodes[i]})},$scope.assinar=function(){userService.isLogged()&&userService.subscribe(id).then(function(res){res.data.success&&($scope.signed=!0,mixpanel.track("podcast subscribe",{"podcast title":podcast.title,"podcast id":id}))})},$scope.desassinar=function(){userService.isLogged()&&userService.unsubscribe(id).then(function(res){res.data.success&&($scope.signed=!1,mixpanel.track("podcast unsubscribe",{"podcast title":podcast.title,"podcast id":id}))})}}),app.controller("PodcastsCtrl",function($scope,$rootScope,$location,$cookies,userService){userService.isLogged()||$location.path("/"),$rootScope.activetab=$location.path(),userService.refreshRootScope(),$scope.podcasts=[],userService.isLogged()&&userService.getPodcasts().then(function(res){res.data.success&&(res.data.response.podcasts.length>0?$scope.podcasts=res.data.response.podcasts:$scope.empty=!0)})}),app.controller("StackCtrl",function($rootScope,$location,$scope,$http,$routeParams){$rootScope.activetab=$location.path(),$scope["delete"]=function(position){position==$rootScope.playing?position==$rootScope.playlist.length-1?($rootScope.$emit("control.prev"),$rootScope.playlist.splice(position,1)):($rootScope.$emit("control.next"),$rootScope.playlist.splice(position,1),$rootScope.playing-=1):($rootScope.playlist.splice(position,1),position<$rootScope.playing&&($rootScope.playing-=1)),$rootScope.playing==-1&&($rootScope.playing=void 0,$rootScope.$emit("control.init"))},$scope.jump=function(position){position!=$rootScope.playing&&($rootScope.$emit("episode.play",$rootScope.playlist[position]),$rootScope.playing=position)}});